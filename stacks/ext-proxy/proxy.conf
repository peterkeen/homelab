proxy_cache_path /cache levels=1:2 keys_zone=sites_cache:64m max_size=10g inactive=2y;

limit_req_zone $binary_remote_addr zone=remoteaddr:10m rate=300r/m;
limit_req zone=remoteaddr burst=100 nodelay;

log_format combined_with_hostname '$http_x_forwarded_for - $remote_user [$time_local] '
                    '$http_host "$request" $status $body_bytes_sent '
                    '"$http_referer" "$http_user_agent"';

access_log /dev/stdout combined_with_hostname;
error_log /dev/stdout info;

# backends
map $http_host $proxy_backend {
  hostnames;

  vmsave.petekeen.net http://vmsave-web:8086;
  www.petekeen.net http://pkdn-up:80;
  default http://smallsites-up:80;
}

# redirects
map $http_host $new_host {
  hostnames;

  default "";

  pkn.me www.petekeen.net;
  www.pkn.me www.petekeen.net;
  petekeen.net www.petekeen.net;
  www.bugsplat.info www.petekeen.net;
  bugsplat.info www.petekeen.net;
  www.bugsplat.org www.petekeen.net;
  bugsplat.org www.petekeen.net;
  www.petekeen.com www.petekeen.net;
  petekeen.com www.petekeen.net;
  www.peterkeen.com www.petekeen.net;
  peterkeen.com www.petekeen.net;
  www.petekeen.org www.petekeen.net;
  petekeen.org www.petekeen.net;

  corastreetpress.com www.corastreetpress.com;

  okapi.io www.okapi.io;
  payola.io www.payola.io;

  masteringmodernpayments.com     www.masteringmodernpayments.com;
  www.masteringmodernpayments.org www.masteringmodernpayments.com;
  masteringmodernpayments.org     www.masteringmodernpayments.com;
  www.masteringmodernpayments.net www.masteringmodernpayments.com;
  masteringmodernpayments.net     www.masteringmodernpayments.com;
  mstr.mp                         www.masteringmodernpayments.com;

  gulfse.cx               bsky.app/profile/rogueprintco.bsky.social/post/3li2dzvrnvs22;
  www.gulfse.cx           bsky.app/profile/rogueprintco.bsky.social/post/3li2dzvrnvs22;
  golfse.cx               bsky.app/profile/rogueprintco.bsky.social/post/3li2dzvrnvs22;
  www.golfse.cx           bsky.app/profile/rogueprintco.bsky.social/post/3li2dzvrnvs22;  
}

map $ssl_server_name $certname {
  hostnames;

  www.pkn.me pkn.me;
  pkn.me pkn.me;
  www.petekeen.net petekeen.net;  
  vmsave.petekeen.net petekeen.net;
  petekeen.net petekeen.net;
  www.bugsplat.info bugsplat.info;
  bugsplat.info bugsplat.info;
  www.bugsplat.org bugsplat.org;
  bugsplat.org bugsplat.org;
  www.petekeen.com petekeen.com;
  petekeen.com petekeen.com;
  www.peterkeen.com peterkeen.com;
  peterkeen.com peterkeen.com;
  www.petekeen.org petekeen.org;
  petekeen.org peterkeen.org;

  www.corastreetpress.com corastreetpress.com;
  corastreetpress.com corastreetpress.com;

  www.okapi.io okapi.io;
  okapi.io okapi.io;
  www.payola.io payola.io;
  payola.io www.payola.io;

  www.masteringmodernpayments.com masteringmodernpayments.com;
  masteringmodernpayments.com     masteringmodernpayments.com;
  www.masteringmodernpayments.org masteringmodernpayments.org;
  masteringmodernpayments.org     masteringmodernpayments.org;
  www.masteringmodernpayments.net masteringmodernpayments.net;
  masteringmodernpayments.net     masteringmodernpayments.net;
  mstr.mp                         mstr.mp;

  gulfse.cx               gulfse.cx;
  www.gulfse.cx           gulfse.cx;
  golfse.cx               golfse.cx;
  www.golfse.cx           golfse.cx;
}

server {
  listen 80 default_server;
  listen [::]:80 default_server;

  access_log /dev/stdout json_combined;
  error_log /dev/stdout info;

  if ($new_host != "") {
     return 301 https://$new_host$request_uri;
  }

  location / {
      return 301 https://$host$request_uri;
  }
}

server { 
  listen 443 ssl http2 default_server;
  listen [::]:443 ssl http2 default_server;

  access_log /dev/stdout json_combined;
  error_log /dev/stdout info;

  server_tokens off;
  
  ssl_certificate /etc/letsencrypt/certificates/$certname.crt;
  ssl_certificate_key /etc/letsencrypt/certificates/$certname.key;
  ssl_session_timeout 1d;
  ssl_session_cache shared:MozSSL:10m;  # about 40000 sessions
  ssl_session_tickets off;
  
  # curl https://ssl-config.mozilla.org/ffdhe2048.txt > /path/to/dhparam
  ssl_dhparam /etc/nginx/dhparam;
  
  # intermediate configuration
  ssl_protocols TLSv1.2 TLSv1.3;
  ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;
  ssl_prefer_server_ciphers off;
  
  # OCSP stapling
  ssl_stapling on;
  ssl_stapling_verify on;
  
  client_max_body_size 1024M;

  resolver 127.0.0.11 ipv6=off;
  
  gzip off;

  proxy_ignore_client_abort on;

  if ($new_host != "") {
    rewrite ^(.*)$ https://$new_host$request_uri permanent;
  }

  location ~* \.php {
    return 503 "";
  }

  location ~* (wp-admin|wp-login|wp-content) {
    return 503 "";
  }

  if ($proxy_backend = "") {
    return 404 "not found";
  }

  location / {
    proxy_http_version 1.1;

    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https;

    proxy_set_header Host $http_host;
    proxy_set_header X-NginX-Proxy true;
    proxy_redirect off;

    # Enables WS support
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";

    add_header X-Cache-Status $upstream_cache_status;
    proxy_cache_key $scheme$http_host$proxy_host$request_uri;
    proxy_cache sites_cache;
    proxy_cache_revalidate on;
    proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504 http_403 http_404 http_429;
    proxy_cache_background_update on;
    proxy_cache_lock on;

    proxy_ssl_verify off;
    proxy_ssl_server_name on;

    proxy_pass $proxy_backend;
  }
}
