<%-
require 'uri'

stage_one = {
  listen: [
    ":80",
    ":443",
  ],
  automatic_https: {
    disable_certificates: true
  },
  routes: []
}

stage_two = {
  listen: [
    "unix//sockets/caddy.sock"
  ],
  automatic_https: {
    disable: true
  },
  routes: []
}

this_host_web_configs do |stack, service, web_conf|
  web_conf[:routes].each do |route|
    if route[:redirect] != nil
      stage_one[:routes] << {
        match: [
          {
            host: [web_conf[:fqdn]],
          },
        ],
        handle: [
          {
            handler: "static_response",
            status_code: 302,
            headers: {
              "Location": [route[:redirect]]
            }
          }
        ]
      }
      next
    end

    stage_one_upstream = route[:anubis] ? "unix//sockets/anubis.sock" : "unix//sockets/caddy.sock"

    stage_one[:routes] << {
      match: [
        {
          host: [web_conf[:fqdn]],
          path: ["#{route[:path]}*"]
        }
      ],
      handle: [
        {
          handler: "reverse_proxy",
          upstreams: [
            { dial: stage_one_upstream }
          ]
        }
      ]
    }

    upstream_host = URI(route[:upstream]).hostname
    upstream_port = URI(route[:upstream]).port.to_s

    stage_two[:routes] << {
      match: [
        {
          host: [web_conf[:fqdn]],
          path: ["#{route[:path]}*"]
        }
      ],
      handle: [
        {
          handler: "reverse_proxy",
          dynamic_upstreams: {
            source: "a",
            resolver: {
              addresses: ["127.0.0.11"],
            },
            name: upstream_host,
            port: upstream_port
          }
        }
      ]
    }
  end
  web_conf[:alternate_hostnames].each do |hostname|
    stage_one[:routes] << {
      match: [
        {
          host: [hostname],
        },
      ],
      handle: [
        {
          handler: "static_response",
          status_code: 302,
          headers: {
            "Location": [
              "https://#{web_conf[:fqdn]}"
            ]
          }
        }
      ]
    }
  end
end

certificates = this_host_certs.keys.map do |certname|
  {
    certificate: "/etc/letsencrypt/certificates/#{certname}.crt",
    key: "/etc/letsencrypt/certificates/#{certname}.key"
  }
end

@config = {
  apps: {
    http: {
      servers: {
        stage_one: stage_one,
        stage_two: stage_two
      }
    },
    tls: {
      certificates: {
        load_files: certificates
      }
    }
  }
}
-%>
<%= JSON.pretty_generate(@config) %>
