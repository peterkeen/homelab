<%-
hostnames_by_ip = Hash.new { |h, k| h[k] = [] }
hostnames_by_ip["10.73.95.42"] << "protect.keen.land"
hostnames_by_ip["10.73.95.46"] << "infra-git.keen.land"
hostnames_by_ip["10.73.95.4"] += [
  "zwave-shed.keen.land",
  "zwave-office.keen.land",
  "zwave-house.keen.land",
  "zwave-garage.keen.land",
  "zigbee-house.keen.land",
  "zigbee-office.keen.land",
  "sabnzbd.keen.land",
]

all_web_configs do |host, _, _, web_conf|
  hostnames_by_ip[host.local_ip] << web_conf[:fqdn]
end

nameservers = []
all_host_services do |host, stack, service|
  if service.name == :coredns
    nameservers << host
  end

  next if service.config.dig(:"x-dns", :skip_service)

  next unless service.config.key?(:ports) || service.config[:network_mode] == "host"

  hostnames_by_ip[host.local_ip] << "#{service.name}.svc.docker.keen.land"
  hostnames_by_ip[host.tailnet_ip] << "#{service.name}.ts.docker.keen.land"
end

hosts.each do |host|
  hostnames_by_ip[host.local_ip] << "#{host.hostname}.#{host.region}.keen.land"
end
-%>
keen.land. IN SOA <%= nameservers.first.hostname %>.keen.land. admin.keen.land. (
    <%= Time.now.to_i %> ; serial
    21600 ; refresh after 6 hours
    900 ; retry after 15 minutes
    1800 ; expire after 30 minutes
    30 ; minimum ttl 30 seconds
)
<%- nameservers.each do |host| %>
keen.land. 30 IN NS <%= host.hostname %>.keen.land.
<%- end -%>

<%- hosts.each do |host| -%>
<%= host.hostname %> 30 IN A <%= host.local_ip %>
<%- end -%>

<%- hostnames_by_ip.sort.each do |ip, hostnames| -%>
<%- hostnames.each do |hostname| -%>
<%= hostname %>. 30 IN A <%= ip %>
<%- end -%>
<%- end -%>
