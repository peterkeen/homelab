#!/bin/ash

set -e

ping_gatus() {
if [[ ! -z "$GATUS_AUTH_TOKEN" ]]; then
    curl -XPOST -H "Authorization: Bearer ${GATUS_AUTH_TOKEN}" "https://gatus.keen.land/api/v1/endpoints/host-backups_${HOSTNAME}/external?success=true"
fi

if [[ ! -s /configs/common/file_list.txt ]]; then
    ping_gatus
    exit 0
fi

echo $BACKUP_KEY > /tmp/backup_key
chmod 600 /tmp/backup_key

<%- this_host.services do |stack, service| -%>
<%- next unless service.config.key?(:"x-backup") && service.config[:"x-backup"].key?(:prepare) -%>
<%- service.config[:"x-backup"][:prepare].each do |script| -%>
docker exec <%= service.config[:container_name] %> <%= script %>
<%- end -%>
<%- end -%>

backup_path=/mnt/tank/backups/hosts/<%= this_host.hostname %>

ssh -i /tmp/backup_key -o StrictHostKeyChecking=no hbackup@10.73.95.84 mkdir -p $backup_path

rsync --rsh "ssh -i /tmp/backup_key -o StrictHostKeyChecking=no" \
    --verbose \
    --recursive \
    --archive \
    --files-from=/common/file_list.txt \
    / hbackup@10.73.95.84:$backup_path

ping_gatus
