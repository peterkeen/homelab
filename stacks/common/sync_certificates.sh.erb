#!/bin/ash

set -e

rsync -e "ssh -i /configs/common/backup_key -o StrictHostKeyChecking=no" -rav hbackup@10.73.95.84:/mnt/tank/backups/hosts/lrrr-docker/data/certificates/ /data/certificates

chown -R root:root /data/certificates
chmod 644 /data/certificates/certificates/*

tar -C / -cf - /data/certificates/certificates/ | sha256sum | cut -d' ' -f1 > /data/certificates/certs.sum

<%- secret = secrets.get("g6tkyx7ryhhdig3vgspawa6c2m") -%>
<%- if secret[this_host.hostname] -%>
curl -XPOST -H "Authorization: Bearer <%= secret[this_host.hostname] %>" 'https://gatus.keen.land/api/v1/endpoints/certificate-sync_<%= this_host.hostname %>/external?success=true'
<%- end -%>
